# Data
We have two data sets:
* clickstream
* users

### Clickstream  Data
```json
{"url": "url_21", "timestamp": 1420070400000, "user": "user_8", "ip": "ip_49"}
{"url": "url_5", "timestamp": 1420070408640, "user": "user_3", "ip": "ip_8"}
```

* timestamp : event time in unix epoch format in milli seconds
* url : url accessed
* user : userid
* ip : IP Address of user

### Users data
```json
{"userid":"user_1", "age" : 20, "gender" : "M"}
{"userid":"user_2", "age" : 25, "gender" : "F"}
```

## Loading Data With Spark

#### Open Spark Shell
```bash
    $   cd  path/to/this/data/dir

    # assuming spark is installed in ~/spark
    $   ~/spark/bin/spark-shell
    # or
    #  $   SPARK_HOME/bin/spark-shell
```

#### Create dataframes for clickstream data
Do the following in Spark-Shell prompt.

```scala

    // read DF.. Spark will figure out schema automatically !
    val clicks = sqlContext.read.json("clickstream.json")

    clicks.count
    /* output
    res1: Long = 20
    */

    // display sample data.
    clicks.show

    /* output
    +------+-------------+------+-------+
    |    ip|    timestamp|   url|   user|
    +------+-------------+------+-------+
    | ip_49|1420070400000|url_21| user_8|
    |  ip_8|1420070408640| url_5| user_3|
    ...
    */

    // register dataframe as a table
    clicks.registerTempTable("clicks")


    // query the temp table
    sqlContext.sql("select * from clicks").show

    /* output
    +------+-------------+------+-------+
    |    ip|    timestamp|   url|   user|
    +------+-------------+------+-------+
    | ip_49|1420070400000|url_21| user_8|
    |  ip_8|1420070408640| url_5| user_3|
    ...

    */
```

#### Create dataframes for users data

Enter the following in spark shell
```scala

    val users = sqlContext.read.json("users.json")
    users.count
    users.show
    users.registerTempTable("users")
    sqlContext.sql("select * from users").show
```


## Queries

### Find how many users are Male ('M') and Female 'F'
```scala

    sqlContext.sql("select gender, count(*) from users group by gender").show

    /* output
    +------+---+
    |gender|_c1|
    +------+---+
    |     F|  5|
    |     M|  5|
    +------+---+
    */
```

### Join clickstream and users data

```scala
    
    sqlContext.sql ("select clicks.*, users.* from clicks join users on (clicks.user = users.userid)").show

    /* output
    +------+-------------+------+------+---+------+------+
    |    ip|    timestamp|   url|  user|age|gender|userid|
    +------+-------------+------+------+---+------+------+
    | ip_49|1420070400000|url_21|user_8| 20|     F|user_8|
    |  ip_8|1420070408640| url_5|user_3| 18|     M|user_3|
    | ip_47|1420070417280|url_48|user_3| 18|     M|user_3|

    */

```


### Find clicks generated by users between the age of 18 and 25

```scala

    sqlContext.sql ("select clicks.*, users.* from clicks join users on (clicks.user = users.userid) where users.age >=18 and users.age <= 25").show

```


### Find top 10 urls accessed by users between the age of 18 and 25
```scala

    sqlContext.sql ("select clicks.url, count(*) as total from clicks join users on (clicks.user = users.userid) group by clicks.url order by total desc limit 10").show

```